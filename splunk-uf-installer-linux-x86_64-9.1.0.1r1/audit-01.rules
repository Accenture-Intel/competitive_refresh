### Accenture security ruleset for AuditD
### acnruleset version 1.8
### based on rules available at https://github.com/linux-audit/audit-userspace/tree/master/rules
### customized by IS Tools team (ICITools.SIEM.Core@accenture.com / petr.vyhnal@accenture.com)
### Version history:
### 1.8 Use -i instead of -c to ignore uknown rules (as seen on older Linux versions) to do not break MS ATP
### 1.7 Re-enabled acnis-command-executed-by-user rule
### 1.6 Fixed few typos
### 1.5 Moved --loginuid-immunable after -c to prevent issues with old AuditD versions
### 1.4 All keys prefixed with 'acnis'
### 1.3 Disabled command-executed-by-user rule
### 1.2 Disabled elevated-privs-session rules
### 1.1 Ruleset expanded with 32-bit rules because of Symantec 32bit Antivirus used in some servers
### 1.0 Initial release

# continue with loading of rules even if some line contains an error
-i

# continue with loading of rules even if some line contains an error
#-c

## Make the loginuid immutable. This prevents tampering with the auid.
--loginuid-immutable

## Cron jobs fill the logs with stuff we normally don't want
-a never,user -F subj_type=crond_t

## This prevents chrony from overwhelming the logs
-a never,exit -F arch=x86_64 -S adjtimex -F auid=unset -F uid=chrony -F subj_type=chronyd_t

### This is not very interesting and wastes a lot of space if
### the server is public facing
-a always,exclude -F msgtype=CRYPTO_KEY_USER

## If you are on a 64 bit platform, everything _should_ be running
## in 64 bit mode. This rule will detect any use of the 32 bit syscalls
## because this might be a sign of someone exploiting a hole in the 32
## bit API.
#-a always,exit -F arch=b32 -S all -F key=32bit-abi

# This rule supresses events that originate on the below file systems.
# Typically you would use this in conjunction with rules to monitor
# kernel modules. The filesystem listed are known to cause hundreds of
# path records during kernel module load. As an aside, if you do see the
# tracefs or debugfs module load and this is a production system, you really
# should look into why its getting loaded and prevent it if possible.
-a never,filesystem -F fstype=tracefs
-a never,filesystem -F fstype=debugfs

## Things that could affect time
-a always,exit -F arch=b32 -S adjtimex,settimeofday -F key=acnis-time-change
-a always,exit -F arch=b32 -S clock_settime -F a0=0x0 -F key=acnis-time-change
-a always,exit -F arch=b64 -S adjtimex,settimeofday -F key=acnis-time-change
-a always,exit -F arch=b64 -S clock_settime -F a0=0x0 -F key=acnis-time-change
    -w /etc/localtime -p wa -k time-change

## unsuccessful creation
-a always,exit -F arch=b32 -S mkdir,creat,link,symlink,mknod,mknodat,linkat,symlinkat -F auid!=4294967295 -F exit=-EACCES -F key=acnis-creation-error
-a always,exit -F arch=b32 -S mkdir,link,symlink,mkdirat -F auid!=4294967295 -F exit=-EPERM -F key=acnis-creation-error
-a always,exit -F arch=b64 -S mkdir,creat,link,symlink,mknod,mknodat,linkat,symlinkat -F auid!=4294967295 -F exit=-EACCES -F key=acnis-creation-error
-a always,exit -F arch=b64 -S mkdir,link,symlink,mkdirat -F auid!=4294967295 -F exit=-EPERM -F key=acnis-creation-error

## unsuccessful open
-a always,exit -F arch=b32 -S open,openat,open_by_handle_at -F auid!=4294967295 -F exit=-EACCES -F key=acnis-open-error
-a always,exit -F arch=b32 -S open,openat,open_by_handle_at -F auid!=4294967295 -F exit=-EPERM -F key=acnis-open-error
-a always,exit -F arch=b64 -S open,openat,open_by_handle_at -F auid!=4294967295 -F exit=-EACCES -F key=acnis-open-error
-a always,exit -F arch=b64 -S open,openat,open_by_handle_at -F auid!=4294967295 -F exit=-EPERM -F key=acnis-open-error

## unsuccessful close
-a always,exit -F arch=b32 -S close -F auid!=4294967295 -F exit=-EIO -F key=acnis-close-error
-a always,exit -F arch=b64 -S close -F auid!=4294967295 -F exit=-EIO -F key=acnis-close-error

## unsuccessful modifications
-a always,exit -F arch=b32 -S rename -S renameat -S truncate -S chmod -S setxattr -S lsetxattr -S removexattr -S lremovexattr -F auid!=4294967295 -F exit=-EACCES -F key=acnis-mods-error
-a always,exit -F arch=b32 -S rename -S renameat -S truncate -S chmod -S setxattr -S lsetxattr -S removexattr -S lremovexattr -F auid!=4294967295 -F exit=-EPERM -F key=acnis-mods-error
-a always,exit -F arch=b64 -S rename -S renameat -S truncate -S chmod -S setxattr -S lsetxattr -S removexattr -S lremovexattr -F auid!=4294967295 -F exit=-EACCES -F key=acnis-mods-error
-a always,exit -F arch=b64 -S rename -S renameat -S truncate -S chmod -S setxattr -S lsetxattr -S removexattr -S lremovexattr -F auid!=4294967295 -F exit=-EPERM -F key=acnis-mods-error

## unsuccessful deletion
-a always,exit -F arch=b32 -S rmdir,unlink,unlinkat -F auid!=4294967295 -F exit=-EACCES -F key=acnis-delete-error
-a always,exit -F arch=b32 -S rmdir,unlink,unlinkat -F auid!=4294967295 -F exit=-EPERM -F key=acnis-delete-error
-a always,exit -F arch=b64 -S rmdir,unlink,unlinkat -F auid!=4294967295 -F exit=-EACCES -F key=acnis-delete-error
-a always,exit -F arch=b64 -S rmdir,unlink,unlinkat -F auid!=4294967295 -F exit=-EPERM -F key=acnis-delete-error

## Use file-integrity monitoring or change-detection software on logs
-a always,exit -F dir=/etc/audit/ -F perm=wa -F key=acnis-modification-audit
-a always,exit -F dir=/var/log/audit/ -F perm=wa -F key=acnis-modification-audit

# elevation of privileges
# Temporarily disabled because it's too verbose in some server
#-a always,exit -F arch=b32 -S setuid -F a0=0 -F exe=/usr/bin/su -F key=acnis-elevated-privs-session
#-a always,exit -F arch=b32 -S setresuid -F a0=0 -F exe=/usr/bin/sudo -F key=acnis-elevated-privs-session
-a always,exit -F arch=b32 -S execve -C uid!=euid -F euid=0 -F key=acnis-elevated-privs-setuid

# Temporarily disabled because it's too verbose in some server
#-a always,exit -F arch=b64 -S setuid -F a0=0 -F exe=/usr/bin/su -F key=acnis-elevated-privs-session
#-a always,exit -F arch=b64 -S setresuid -F a0=0 -F exe=/usr/bin/sudo -F key=acnis-elevated-privs-session
-a always,exit -F arch=b64 -S execve -C uid!=euid -F euid=0 -F key=acnis-elevated-privs-setuid

## All changes, additions, or deletions to any account are logged
## This is implicitly covered by shadow-utils. We will place some rules
## in case someone tries to hand edit the trusted databases
-a always,exit -F path=/etc/group -F perm=wa -F key=acnis-group-change
-w /etc/sudoers -p wa -k acnis-sudo-change
-w /etc/sudoers.d -p wa -k acnis-sudo-change

# Tracking of privileged commands execution
